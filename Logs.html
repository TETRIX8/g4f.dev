<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .log-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-entry:hover {
            background-color: #f8f9fa;
        }
        
        /* –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .log-entry:contains("‚úÖ") { color: #28a745; }
        .log-entry:contains("‚ùå") { color: #dc3545; }
        .log-entry:contains("‚ö†Ô∏è") { color: #ffc107; }
        .log-entry:contains("üîç") { color: #17a2b8; }
        .log-entry:contains("üì•") { color: #6f42c1; }
        .log-entry:contains("üì§") { color: #fd7e14; }
        .log-entry:contains("‚ö°") { color: #20c997; }
        .log-entry:contains("üîÑ") { color: #6c757d; }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .stats {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .empty-logs {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>
            üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤
            <small style="opacity: 0.8; font-size: 14px; font-weight: normal;">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</small>
        </h2>
    </div>
    
    <div class="controls">
        <button class="btn btn-primary" onclick="refreshLogs()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn btn-danger" onclick="clearLogs()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn btn-success" onclick="exportLogs()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
        <input type="text" class="filter-input" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–∫—Å—Ç—É..." onkeyup="filterLogs(this.value)">
        <div class="stats" id="stats">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <div class="log-container" id="logContainer">
        <div class="empty-logs">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
    </div>

    <script>
        let allLogs = [];
        
        function loadLogs() {
            google.script.run
                .withSuccessHandler(displayLogs)
                .withFailureHandler(showError)
                .getUserLogs();
        }
        
        function displayLogs(logs) {
            allLogs = logs || [];
            const container = document.getElementById('logContainer');
            const stats = document.getElementById('stats');
            
            if (allLogs.length === 0) {
                container.innerHTML = '<div class="empty-logs">üìù –õ–æ–≥–∏ –ø—É—Å—Ç—ã</div>';
                stats.textContent = '–ó–∞–ø–∏—Å–µ–π: 0';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            const reversedLogs = [...allLogs].reverse();
            
            container.innerHTML = reversedLogs
                .map(log => `<div class="log-entry">${escapeHtml(log)}</div>`)
                .join('');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const errorCount = logs.filter(log => log.includes('‚ùå')).length;
            const successCount = logs.filter(log => log.includes('‚úÖ')).length;
            const warningCount = logs.filter(log => log.includes('‚ö†Ô∏è')).length;
            
            stats.innerHTML = `
                –í—Å–µ–≥–æ: ${allLogs.length} | 
                ‚úÖ –£—Å–ø–µ—Ö: ${successCount} | 
                ‚ùå –û—à–∏–±–∫–∏: ${errorCount} | 
                ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: ${warningCount}
            `;
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –∫ –Ω–æ–≤—ã–º –∑–∞–ø–∏—Å—è–º
            container.scrollTop = 0;
        }
        
        function showError(error) {
            const container = document.getElementById('logContainer');
            container.innerHTML = `
                <div class="empty-logs" style="color: #dc3545;">
                    ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:<br>
                    ${escapeHtml(error.message || error)}
                </div>
            `;
        }
        
        function refreshLogs() {
            document.getElementById('stats').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            loadLogs();
        }
        
        function clearLogs() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏?')) {
                return;
            }
            
            google.script.run
                .withSuccessHandler(() => {
                    allLogs = [];
                    displayLogs([]);
                    alert('‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
                })
                .withFailureHandler(error => alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`))
                .clearLogs();
        }
        
        function exportLogs() {
            if (allLogs.length === 0) {
                alert('–ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            const content = allLogs.join('\n');
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function filterLogs(searchText) {
            const entries = document.querySelectorAll('.log-entry');
            const search = searchText.toLowerCase();
            
            let visibleCount = 0;
            entries.forEach(entry => {
                const text = entry.textContent.toLowerCase();
                if (search === '' || text.includes(search)) {
                    entry.classList.remove('hidden');
                    visibleCount++;
                } else {
                    entry.classList.add('hidden');
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
            if (search !== '') {
                const stats = document.getElementById('stats');
                const originalText = stats.textContent;
                if (!originalText.includes('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ')) {
                    stats.textContent += ` | –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: ${visibleCount}`;
                } else {
                    stats.textContent = originalText.replace(/–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: \d+/, `–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: ${visibleCount}`);
                }
            } else {
                // –£–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                const stats = document.getElementById('stats');
                stats.textContent = stats.textContent.replace(/ \| –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: \d+/, '');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadLogs, 30000);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        loadLogs();
        
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshLogs();
                        break;
                    case 'f':
                        e.preventDefault();
                        document.querySelector('.filter-input').focus();
                        break;
                }
            }
        });
    </script>
</body>
</html>